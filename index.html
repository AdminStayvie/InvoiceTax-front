<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice App - Stay.vie & Tax Plus</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%234A5568%22/><text x=%2250%22 y=%2255%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22 dy=%22.3em%22 font-family=%22sans-serif%22>S+</text></svg>">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Konfigurasi Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-dark': '#4A5568', // Abu-abu gelap dari logo
                        'brand-green': '#689F38', // Hijau dari logo
                        'brand-gold': '#CBB284', // Emas untuk Stay.vie
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom CSS */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .loader {
            border: 5px solid #E2E8F0;
            border-top: 5px solid #4A5568;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-label {
            display: block; font-size: 0.875rem; font-weight: 500;
            margin-bottom: 0.25rem; color: #4B5563;
        }

        .form-input {
            background-color: #F9FAFB; border: 1px solid #D1D5DB;
            color: #111827; font-size: 0.875rem; border-radius: 0.5rem;
            width: 100%; display: block; padding: 0.625rem;
            transition: color 0.2s, border-color 0.2s;
        }

        .form-input:focus {
            outline: none; border-color: #4A5568;
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.4);
        }
        
        .invoice-stamp {
            position: absolute;
            top: 60px;
            right: 40px;
            border: 5px solid;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 2.5rem;
            font-weight: 700;
            text-transform: uppercase;
            transform: rotate(15deg);
            opacity: 0.8;
            letter-spacing: 0.1em;
            pointer-events: none;
        }
        .paid-stamp { color: #38A169; border-color: #38A169; }
        .dp-stamp { color: #DD6B20; border-color: #DD6B20; font-size: 2rem; }


        /* Print-specific styles */
        @media print {
            @page { size: A4; margin: 0; }
            html, body {
                margin: 0; padding: 0; background-color: #fff !important;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            body * { visibility: hidden; }
            #invoice-modal, #invoice-content, #invoice-modal * { visibility: visible; }
            #invoice-modal {
                position: absolute; left: 0; top: 0; width: 100%; height: 100%;
                padding: 0; display: block; overflow: visible;
                background-color: #fff !important;
            }
            #invoice-modal>div {
                transform: none !important; box-shadow: none !important;
                border-radius: 0 !important; width: 100% !important;
                max-width: 100% !important; height: 100%;
            }
            #invoice-content { padding: 1.5cm; font-size: 10pt; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen">
        <!-- SIDEBAR NAVIGATION -->
        <aside id="sidebar" class="w-72 bg-white shadow-lg flex-shrink-0 flex flex-col p-4 transition-all duration-300">
            <!-- Konten sidebar akan di-inject oleh JavaScript -->
        </aside>

        <!-- MAIN CONTENT -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
            <!-- Konten halaman akan di-inject di sini oleh JavaScript -->
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modal-container">
        <!-- Modal akan di-inject di sini -->
    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        const API_BASE_URL = 'https://invtax-backend.stayvie.com/api'; // Ganti dengan URL backend Anda

        // --- State Aplikasi ---
        const appState = {
            currentPage: 1,
            totalPages: 1,
            searchQuery: '',
            debounceTimer: null,
        };

        // --- Helper Functions ---
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(n || 0);
        const formatTanggal = (d) => new Date(d).toLocaleDateString('id-ID', {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            timeZone: 'UTC'
        });
        const formatDateForInput = (d) => {
            if (!d) return '';
            const date = new Date(d);
            return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}`;
        };

        // --- Logika Modal & Notifikasi ---
        function showModal(id, content) {
            hideModal();
            const container = document.getElementById('modal-container');
            container.innerHTML = `<div id="${id}" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">${content}</div>`;
        }

        function hideModal() {
            const container = document.getElementById('modal-container');
            if (container) {
                container.innerHTML = '';
            }
        }

        function showStatusModal(title, message, isSuccess) {
            const icon = isSuccess ? `<i data-feather="check-circle" class="w-16 h-16 text-brand-green mx-auto"></i>` : `<i data-feather="x-circle" class="w-16 h-16 text-red-500 mx-auto"></i>`;
            showModal('status-modal', `
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
                    <div class="mb-4">${icon}</div>
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <button onclick="hideModal()" class="w-full bg-brand-dark text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors">Tutup</button>
                </div>
            `);
            feather.replace();
        }

        function confirmDelete(id, name, type) {
            const content = `
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
                    <div class="mb-4"><i data-feather="alert-triangle" class="w-16 h-16 text-yellow-500 mx-auto"></i></div>
                    <h3 class="text-xl font-bold mb-2">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus invoice untuk <strong>${name}</strong>?</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="hideModal()" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="confirm-delete-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Ya, Hapus</button>
                    </div>
                </div>
            `;
            showModal('confirm-modal', content);
            feather.replace();
            document.getElementById('confirm-delete-btn').onclick = () => deleteInvoice(id, type);
        }

        async function deleteInvoice(id, type) {
            try {
                const response = await fetch(`${API_BASE_URL}/invoices/${type}/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Gagal menghapus invoice.');
                hideModal();
                showStatusModal('Sukses', 'Invoice berhasil dihapus.', true);
                fetchInvoices(type);
            } catch (error) {
                hideModal();
                showStatusModal('Gagal', error.message, false);
            }
        }
        
        // --- ROUTER & NAVIGATION ---
        const routes = {
            '/taxplus': () => renderInvoiceListView('taxplus'),
            '/hotel': () => renderInvoiceListView('hotel'),
            '/new': showNewInvoiceTypeSelectionModal,
            '/new/taxplus': () => renderForm('taxplus'),
            '/new/hotel': () => renderForm('hotel'),
        };

        function router() {
            const path = window.location.hash.replace('#', '') || '/hotel'; // Default ke hotel
            const routeKey = path.startsWith('/new/') ? path.substring(0, path.lastIndexOf('/')) : path;
            const handler = routes[routeKey] || routes['/hotel'];
            
            if (routeKey === '/new') {
                 routes[path]();
            } else if (path.startsWith('/new/')) {
                const type = path.split('/')[1];
                handler(type);
            }
            else {
                handler();
            }

            renderSidebar(path);
        }

        // --- RENDERING FUNCTIONS ---
        function renderSidebar(activePath) {
            const sidebar = document.getElementById('sidebar');
            const links = [{
                path: '/hotel',
                icon: 'home',
                label: 'Data Invoice Kamar Hotel'
            }, {
                path: '/taxplus',
                icon: 'briefcase',
                label: 'Data Invoice TaxPlus'
            }, {
                path: '/new',
                icon: 'plus-circle',
                label: 'Buat Invoice Baru'
            }, ];
            sidebar.innerHTML = `
                <div class="flex items-center gap-3 mb-12">
                     <img src="${API_BASE_URL.replace('/api', '')}/Logo_stayvie.png" alt="Stay.vie Logo" class="h-10">
                    <h1 class="text-lg font-bold text-brand-dark">Invoice App</h1>
                </div>
                <nav class="flex flex-col gap-3">
                    ${links.map(link => {
                        const isActive = activePath.startsWith(link.path) && link.path !== '/';
                        return `
                        <a href="#${link.path}" class="flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${isActive ? 'bg-gray-200 text-brand-dark font-semibold' : 'text-gray-500 hover:bg-gray-100'}">
                            <i data-feather="${link.icon}"></i>
                            <span>${link.label}</span>
                        </a>`
                    }).join('')}
                </nav>
            `;
            feather.replace();
        }

        function renderContent(title, subtitle, content) {
            document.getElementById('main-content').innerHTML = `
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">${title}</h2>
                    <p class="text-gray-500 mt-1">${subtitle}</p>
                </header>
                ${content}
            `;
            feather.replace();
        }
        
        function showNewInvoiceTypeSelectionModal() {
            const path = window.location.hash.replace('#', '') || '/hotel';
            renderInvoiceListView(path.split('/')[1] || 'hotel');
            const content = `
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
                    <h3 class="text-xl font-bold mb-6">Pilih Jenis Invoice</h3>
                    <div class="flex flex-col gap-4">
                        <button onclick="window.location.hash='/new/hotel'; hideModal();" class="w-full bg-brand-gold text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity">Invoice Kamar Hotel</button>
                        <button onclick="window.location.hash='/new/taxplus'; hideModal();" class="w-full bg-brand-green text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity">Invoice TaxPlus</button>
                    </div>
                    <button onclick="hideModal()" class="mt-6 text-sm text-gray-500 hover:underline">Batal</button>
                </div>
            `;
            showModal('invoice-type-selection', content);
        }

        // --- PAGE: INVOICE TABLE ---
        function renderInvoiceListView(type) {
            const isHotel = type === 'hotel';
            const title = isHotel ? 'Data Invoice Kamar Hotel' : 'Data Invoice TaxPlus';
            const subtitle = `Kelola semua data invoice untuk ${isHotel ? 'Kamar Hotel' : 'TaxPlus'}.`;

            const content = `
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <input type="text" id="search-input" placeholder="Cari berdasarkan nama klien..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-dark focus:border-brand-dark block w-full md:w-80 p-2.5">
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="p-4">No. Invoice</th>
                                <th class="p-4">Nama Klien</th>
                                <th class="p-4">Tanggal</th>
                                <th class="p-4">Sisa Tagihan</th>
                                <th class="p-4">Status</th>
                                <th class="p-4">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-table-body"></tbody>
                    </table>
                </div>
                <div id="pagination-controls" class="flex justify-between items-center mt-6"></div>
            `;
            renderContent(title, subtitle, content);
            document.getElementById('search-input').addEventListener('input', (e) => {
                clearTimeout(appState.debounceTimer);
                appState.debounceTimer = setTimeout(() => {
                    appState.searchQuery = e.target.value;
                    appState.currentPage = 1;
                    fetchInvoices(type);
                }, 400);
            });
            fetchInvoices(type);
        }

        async function fetchInvoices(type) {
            const tableBody = document.getElementById('invoice-table-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-10"><div class="loader mx-auto"></div></td></tr>`;
            const { currentPage, searchQuery } = appState;
            try {
                const res = await fetch(`${API_BASE_URL}/invoices/${type}?page=${currentPage}&search=${searchQuery}`);
                if (!res.ok) throw new Error("Gagal mengambil data dari server.");
                const { data, ...pagination } = await res.json();
                appState.totalPages = pagination.totalPages;

                tableBody.innerHTML = data.length ? data.map(inv => {
                    const total = inv.items.reduce((sum, i) => sum + i.total, 0);
                    const totalPaid = (inv.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    const remainingBalance = total - totalPaid;

                    let statusBadgeHtml;
                    switch(inv.status) {
                        case 'lunas': statusBadgeHtml = `<span class="status-badge text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">Lunas</span>`; break;
                        case 'dp lunas': statusBadgeHtml = `<span class="status-badge text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-orange-100 text-orange-800">DP Lunas</span>`; break;
                        default: statusBadgeHtml = `<span class="status-badge text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">Belum Lunas</span>`;
                    }
                    
                    return `
                    <tr class="border-b hover:bg-gray-50" data-invoice-id="${inv._id}">
                        <td class="p-4 font-semibold text-gray-900">${inv.nomorInvoice}</td>
                        <td class="p-4">${inv.namaKlien}</td>
                        <td class="p-4">${formatTanggal(inv.tanggalInvoice)}</td>
                        <td class="p-4 font-semibold">${formatRupiah(remainingBalance)}</td>
                        <td class="p-4">${statusBadgeHtml}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                <button onclick="showInvoiceModal('${inv._id}', '${type}')" class="text-gray-400 hover:text-brand-green" title="Lihat & Tambah Pembayaran"><i data-feather="dollar-sign" class="w-5 h-5"></i></button>
                                <button onclick="confirmDelete('${inv._id}', '${inv.namaKlien}', '${type}')" class="text-gray-400 hover:text-red-600" title="Hapus Invoice"><i data-feather="trash-2" class="w-5 h-5"></i></button>
                            </div>
                        </td>
                    </tr>`
                }).join('') : `<tr><td colspan="6" class="text-center py-10 text-gray-500">Tidak ada data.</td></tr>`;
                feather.replace();
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-red-500">${error.message}</td></tr>`;
            }
        }

        // --- PAGE: ENTRY FORM ---
        function renderForm(type) {
            const isHotel = type === 'hotel';
            const title = `Buat Invoice ${isHotel ? 'Kamar Hotel' : 'TaxPlus'} Baru`;
            const content = `
                <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <form id="invoice-form" class="space-y-6">
                         <input type="hidden" id="invoiceType" value="${type}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="namaKlien" class="form-label">Nama Klien</label>
                                <input type="text" id="namaKlien" name="namaKlien" class="form-input" required>
                            </div>
                             <div>
                                <label for="noTelepon" class="form-label">No. Telepon</label>
                                <input type="tel" id="noTelepon" name="noTelepon" class="form-input" required>
                            </div>
                            <div>
                                <label for="tanggalInvoice" class="form-label">Tanggal Invoice</label>
                                <input type="date" id="tanggalInvoice" name="tanggalInvoice" class="form-input" required>
                            </div>
                        </div>
                        <div id="item-list" class="space-y-4 pt-4 border-t">
                            <div class="item-row grid grid-cols-12 gap-3 items-end">
                                <div class="col-span-5"><label class="form-label">Deskripsi</label><input type="text" name="deskripsi" class="form-input item-deskripsi" required></div>
                                <div class="col-span-2"><label class="form-label">Kuantitas</label><input type="number" name="kuantitas" value="1" class="form-input item-kuantitas" required></div>
                                <div class="col-span-2"><label class="form-label">Harga Satuan</label><input type="number" name="harga" class="form-input item-harga" required></div>
                                <div class="col-span-2"><label class="form-label">Total</label><input type="text" name="total" class="form-input bg-gray-100" readonly></div>
                                <div class="col-span-1"></div>
                            </div>
                        </div>
                        <button type="button" id="add-item-btn" class="text-sm font-semibold text-brand-green hover:text-green-700 flex items-center gap-2"><i data-feather="plus"></i> Tambah Item</button>
                        
                        <div class="pt-4 border-t grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label for="downPayment" class="form-label">Uang Muka (DP)</label>
                                <input type="number" id="downPayment" name="downPayment" class="form-input" placeholder="0">
                            </div>
                        </div>

                        <div class="flex justify-end pt-6 border-t">
                            <button type="submit" class="bg-brand-dark text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800 transition-colors">Simpan Invoice</button>
                        </div>
                    </form>
                </div>
            `;
            renderContent(title, 'Isi detail di bawah untuk membuat invoice.', content);
            document.getElementById('tanggalInvoice').value = formatDateForInput(new Date());
            attachFormEventListeners();
        }

        function attachFormEventListeners() {
            const form = document.getElementById('invoice-form');
            const itemList = document.getElementById('item-list');

            const updateItemTotal = (row) => {
                const qty = parseFloat(row.querySelector('.item-kuantitas').value) || 0;
                const price = parseFloat(row.querySelector('.item-harga').value) || 0;
                row.querySelector('input[name="total"]').value = formatRupiah(qty * price);
            };

            itemList.addEventListener('input', (e) => {
                if (e.target.classList.contains('item-kuantitas') || e.target.classList.contains('item-harga')) {
                    updateItemTotal(e.target.closest('.item-row'));
                }
            });

            document.getElementById('add-item-btn').addEventListener('click', () => {
                const newItemRow = `
                    <div class="item-row grid grid-cols-12 gap-3 items-end mt-4">
                        <div class="col-span-5"><input type="text" name="deskripsi" class="form-input item-deskripsi" required></div>
                        <div class="col-span-2"><input type="number" name="kuantitas" value="1" class="form-input item-kuantitas" required></div>
                        <div class="col-span-2"><input type="number" name="harga" class="form-input item-harga" required></div>
                        <div class="col-span-2"><input type="text" name="total" class="form-input bg-gray-100" readonly></div>
                        <div class="col-span-1 flex items-center justify-center"><button type="button" class="remove-item-btn text-red-500 hover:text-red-700 p-2"><i data-feather="trash-2" class="w-5 h-5"></i></button></div>
                    </div>`;
                itemList.insertAdjacentHTML('beforeend', newItemRow);
                feather.replace();
            });

            itemList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-item-btn');
                if (removeBtn) {
                    removeBtn.closest('.item-row').remove();
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const type = document.getElementById('invoiceType').value;
                const items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
                    deskripsi: row.querySelector('.item-deskripsi').value,
                    kuantitas: parseFloat(row.querySelector('.item-kuantitas').value),
                    harga: parseFloat(row.querySelector('.item-harga').value),
                    total: parseFloat(row.querySelector('.item-kuantitas').value) * parseFloat(row.querySelector('.item-harga').value)
                }));

                const data = {
                    namaKlien: document.getElementById('namaKlien').value,
                    noTelepon: document.getElementById('noTelepon').value,
                    tanggalInvoice: document.getElementById('tanggalInvoice').value,
                    items: items,
                    downPayment: parseFloat(document.getElementById('downPayment').value) || 0
                };

                try {
                    const res = await fetch(`${API_BASE_URL}/invoices/${type}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    if (!res.ok) throw new Error('Gagal menyimpan invoice.');
                    showStatusModal('Sukses', 'Invoice baru berhasil disimpan!', true);
                    setTimeout(() => {
                        hideModal();
                        window.location.hash = `/${type}`;
                    }, 1500);
                } catch (error) {
                    showStatusModal('Gagal', error.message, false);
                }
            });
        }
        
        async function addPayment(id, type) {
            const amountInput = document.getElementById('new-payment-amount');
            const dateInput = document.getElementById('new-payment-date');
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;

            if (!amount || amount <= 0) {
                showStatusModal('Gagal', 'Masukkan jumlah pembayaran yang valid.', false); return;
            }
            if (!date) {
                showStatusModal('Gagal', 'Pilih tanggal pembayaran.', false); return;
            }

            const addButton = document.getElementById('add-payment-btn');
            addButton.disabled = true;
            addButton.innerHTML = 'Menyimpan...';

            try {
                const response = await fetch(`${API_BASE_URL}/invoices/${type}/${id}/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, date })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Gagal menambahkan pembayaran.');
                }
                
                await showInvoiceModal(id, type);
                fetchInvoices(type);

            } catch(error) {
                showStatusModal('Gagal', error.message, false);
            }
        }
        
        function confirmDeletePayment(invoiceId, type, paymentId, amount) {
            const content = `
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
                    <div class="mb-4"><i data-feather="alert-triangle" class="w-16 h-16 text-yellow-500 mx-auto"></i></div>
                    <h3 class="text-xl font-bold mb-2">Hapus Pembayaran</h3>
                    <p class="text-gray-600 mb-6">Anda yakin ingin menghapus pembayaran sebesar <strong>${formatRupiah(amount)}</strong>?</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="hideModal()" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Batal</button>
                        <button id="confirm-delete-payment-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Ya, Hapus</button>
                    </div>
                </div>
            `;
            showModal('confirm-payment-delete-modal', content);
            feather.replace();
            document.getElementById('confirm-delete-payment-btn').onclick = () => deletePayment(invoiceId, type, paymentId);
        }

        async function deletePayment(invoiceId, type, paymentId) {
            hideModal();
            try {
                const response = await fetch(`${API_BASE_URL}/invoices/${type}/${invoiceId}/payment/${paymentId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                     const errorData = await response.json();
                    throw new Error(errorData.message || 'Gagal menghapus pembayaran.');
                }
                await showInvoiceModal(invoiceId, type);
                fetchInvoices(type);
            } catch(error) {
                 showStatusModal('Gagal', error.message, false);
            }
        }


        // --- INVOICE MODAL ---
        async function showInvoiceModal(id, type) {
            showModal('invoice-modal', `<div class="bg-white rounded-lg p-8 w-full max-w-4xl"><div class="loader mx-auto"></div></div>`);
            try {
                const res = await fetch(`${API_BASE_URL}/invoices/${type}/${id}`);
                const data = await res.json();
                const total = data.items.reduce((sum, i) => sum + i.total, 0);
                const totalPaid = (data.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const remaining = total - totalPaid;

                const isHotel = type === 'hotel';
                const logoUrl = isHotel ? `${API_BASE_URL.replace('/api', '')}/Logo_stayvie.png` : `${API_BASE_URL.replace('/api', '')}/Logo.png`;
                
                let stamp = '';
                if(data.status === 'lunas') {
                    stamp = `<div class="invoice-stamp paid-stamp">Lunas</div>`;
                } else if(data.status === 'dp lunas') {
                    stamp = `<div class="invoice-stamp dp-stamp">DP Lunas</div>`;
                }

                const headerDetails = isHotel ?
                    `<div>
                        <h1 class="text-2xl font-bold text-brand-gold">Stay.vie Hotel & Co-Living</h1>
                        <p class="text-sm text-gray-500">Dinoyo Prime</p>
                        <p class="text-sm text-gray-500">Jl. Dinoyo 131-133 Surabaya, 60265</p>
                        <p class="text-sm text-gray-500">@stay.vie | www.stayvie.com | 0822-2122-3100</p>
                    </div>` :
                    `<div>
                        <h1 class="text-2xl font-bold text-brand-dark">Tax Plus Indonesia</h1>
                        <p class="text-sm text-gray-500">Jl. Dinoyo 131-133 Surabaya, 60265</p>
                        <p class="text-sm text-gray-500">@taxplus.id | taxplus.idn@gmail.com | +62822-2340-2300</p>
                    </div>`;
                
                const paymentDetails = isHotel ?
                    `<div class="text-sm text-gray-800 leading-relaxed">
                        <p><span class="font-semibold w-24 inline-block">Bank</span>: BCA</p>
                        <p><span class="font-semibold w-24 inline-block">No. Rekening</span>: 4649898798</p>
                        <p><span class="font-semibold w-24 inline-block">Atas Nama</span>: Octavianus Stevie Lianto</p>
                     </div>` :
                     `<div class="text-sm text-gray-800 leading-relaxed">
                        <p><span class="font-semibold w-24 inline-block">Bank</span>: BCA</p>
                        <p><span class="font-semibold w-24 inline-block">No. Rekening</span>: 4649989980</p>
                        <p><span class="font-semibold w-24 inline-block">Atas Nama</span>: Octavianus Stevie Lianto</p>
                    </div>`;

                const content = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl">
                         <div class="p-4 bg-gray-50 flex justify-end gap-3 no-print absolute top-0 right-0 rounded-tr-lg">
                            <button onclick="hideModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Tutup</button>
                            <button onclick="window.print()" class="bg-brand-green text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2"><i data-feather="printer"></i> Print</button>
                        </div>
                        <div id="invoice-content" class="p-10 relative overflow-hidden">
                            ${stamp}
                            <header class="flex justify-between items-start mb-10">
                                <div class="flex items-center gap-5">
                                    <img src="${logoUrl}" alt="Logo" class="h-20">
                                    ${headerDetails}
                                </div>
                                <div class="text-right">
                                    <h2 class="text-4xl font-bold text-gray-400 tracking-wider">INVOICE</h2>
                                    <p class="font-semibold text-gray-700">${data.nomorInvoice}</p>
                                </div>
                            </header>
                            <div class="flex justify-between mb-10">
                                <div>
                                    <p class="text-sm text-gray-500">Ditagihkan kepada:</p>
                                    <p class="text-lg font-bold text-gray-800">${data.namaKlien}</p>
                                    <p class="text-sm text-gray-600">${data.noTelepon || ''}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">Tanggal:</p>
                                    <p class="font-semibold text-gray-800">${formatTanggal(data.tanggalInvoice)}</p>
                                </div>
                            </div>
                            
                           <div class="grid grid-cols-12 gap-8">
                                <div class="col-span-8">
                                     <h3 class="text-sm font-semibold text-gray-600 mb-2">Rincian Tagihan:</h3>
                                    <table class="w-full mb-4">
                                        <thead class="border-b-2 border-gray-300">
                                            <tr>
                                                <th class="text-left py-2 text-sm uppercase text-gray-500">Deskripsi</th>
                                                <th class="text-right py-2 text-sm uppercase text-gray-500">Kuantitas</th>
                                                <th class="text-right py-2 text-sm uppercase text-gray-500">Harga Satuan</th>
                                                <th class="text-right py-2 text-sm uppercase text-gray-500">Jumlah</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.items.map(item => `
                                                <tr class="border-b border-gray-100">
                                                    <td class="py-3">${item.deskripsi}</td>
                                                    <td class="text-right py-3">${item.kuantitas}</td>
                                                    <td class="text-right py-3">${formatRupiah(item.harga)}</td>
                                                    <td class="text-right py-3 font-semibold">${formatRupiah(item.total)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                     <h3 class="text-sm font-semibold text-gray-600 mb-2 mt-8">Rincian Pembayaran:</h3>
                                     ${(data.payments && data.payments.length > 0) ? `
                                        <table class="w-full mb-10">
                                            <thead class="border-b-2 border-gray-300">
                                                <tr>
                                                    <th class="text-left py-2 text-sm uppercase text-gray-500">Tanggal</th>
                                                    <th class="text-left py-2 text-sm uppercase text-gray-500">Keterangan</th>
                                                    <th class="text-right py-2 text-sm uppercase text-gray-500">Jumlah</th>
                                                    <th class="text-right py-2 text-sm uppercase text-gray-500 no-print">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.payments.map(p => `
                                                    <tr class="border-b border-gray-100">
                                                        <td class="py-2">${formatTanggal(p.date)}</td>
                                                        <td class="py-2">${p.notes}</td>
                                                        <td class="text-right py-2">${formatRupiah(p.amount)}</td>
                                                        <td class="text-right py-2 no-print"><button onclick="confirmDeletePayment('${id}', '${type}', '${p._id}', ${p.amount})" class="text-red-500 hover:text-red-700"><i data-feather="x" class="w-4 h-4"></i></button></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    ` : `<p class="text-sm text-gray-500 mb-10">Belum ada pembayaran.</p>`}
                                </div>
                                <div class="col-span-4 pt-8">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <table class="w-full">
                                             <tfoot>
                                                <tr>
                                                    <td class="py-2 font-semibold">SUBTOTAL</td>
                                                    <td class="text-right py-2 font-semibold w-2/5">${formatRupiah(total)}</td>
                                                </tr>
                                                <tr>
                                                    <td class="py-2 font-semibold">TOTAL DIBAYAR</td>
                                                    <td class="text-right py-2 font-semibold w-2/5 text-green-600">${formatRupiah(totalPaid)}</td>
                                                </tr>
                                                <tr class="border-t-2 border-gray-200">
                                                    <td class="py-4 font-bold text-lg">SISA TAGIHAN</td>
                                                    <td class="text-right py-4 font-bold text-lg w-2/5 text-brand-dark">${formatRupiah(remaining)}</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div class="mt-4 no-print">
                                    ${data.status !== 'lunas' ? `
                                        <h4 class="text-sm font-semibold text-gray-600 mb-2">Tambah Pembayaran Baru</h4>
                                        <div class="space-y-3">
                                            <input type="number" id="new-payment-amount" placeholder="Nominal" class="form-input">
                                            <input type="date" id="new-payment-date" value="${formatDateForInput(new Date())}" class="form-input">
                                            <button id="add-payment-btn" onclick="addPayment('${id}', '${type}')" class="w-full bg-brand-dark text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800">Simpan Pembayaran</button>
                                        </div>
                                    ` : `<p class="text-sm text-center font-semibold text-green-600 bg-green-50 p-3 rounded-lg">Invoice ini sudah lunas.</p>`}
                                    </div>
                                </div>
                           </div>

                            <div class="mt-10 pt-6 border-t border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-600 mb-2">Tujuan Pembayaran:</h3>
                                ${paymentDetails}
                            </div>

                            <footer class="text-center text-sm text-gray-500 mt-10">
                                <p>Terima kasih atas kepercayaan Anda.</p>
                            </footer>
                        </div>
                       
                    </div>
                `;
                showModal('invoice-modal', content);
                feather.replace();
            } catch (error) {
                showStatusModal('Gagal', 'Gagal memuat detail invoice.', false);
            }
        }

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            window.addEventListener('hashchange', router);
            router(); // Panggil router saat halaman pertama kali dimuat
        });
    </script>
</body>
</html>


